<!DOCTYPE html>
<html>
<head>
    {% include 'include/phaser.html' %}

    {% load staticfiles %}
    <meta name="viewport" content="minimal-ui, width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
</head>
<body>
    <script type="text/javascript">
    //TODO Drag scene
    //TODO some debug animation maybe?
    //TODO Compile program of commands
    //TODO JSON level like a human plz
    var width = document.body.offsetWidth;
    var height = document.body.offsetHeight;
    var div = {
        width: 50,
        height: 50
    };
    var speed = 1000;
    if (height > width){
        alert("For better experience - turn device!");
        document.location.reload();
    }

    var game = new Phaser.Game(width, height, Phaser.AUTO, 'Pluto', {preload: preload, create: create, update: update});
    var command;
    var program;
    var scene;

    var commands = {};
    var programs = [];
    var tiles = [];
    var hero = {};

    var program_scroll;

    var defaultFont = {font: "25px Arial", fill: "black", align: "center"};

    function preload() {
        game.load.image("forward", "{% static "asserts/forward.png" %}");
        game.load.image("backward", "{% static "asserts/backward.png" %}");
        game.load.image("left", "{% static "asserts/left.png" %}");
        game.load.image("right", "{% static "asserts/right.png" %}");
        game.load.image("lo", "{% static "asserts/lo.png" %}");
        game.load.image("op", "{% static "asserts/op.png" %}");

        game.load.image("pluto", "{% static "asserts/prop/pluto.png" %}");

        game.load.image("tile_default", "{% static "asserts/tiles/default.png" %}");
        game.load.image("tile_finish", "{% static "asserts/tiles/finish.png" %}");
    }

    function create() {
        createProgramPanel();
        createCommandPanel();
        createScenePanel();
        game.camera.x += 100;
    }

    function createProgramPanel(){
        //Program
        program = game.add.group();
        program.inputEnableChildren = true;
        program.x = 0;
        program.y = 0;
        program.w = width;
        program.h = div.height * 1.5;
        var program_holder = game.add.graphics(0, 0);
        program_holder.beginFill(0xc1c1c1, 0.85);
        program_holder.drawRect(0, 0, program.w, program.h);
        program_holder.endFill();
        program.addChild(program_holder);


        var tmp_scroll = game.add.graphics(0, 0);
        tmp_scroll.beginFill(0xc1c1c1, 1);
        tmp_scroll.drawRect(0, 0, program.w/4, div.height/4);
        tmp_scroll.endFill();
        program_scroll = game.add.sprite(0, program.h - div.height/4);
        program_scroll.inputEnabled = true;
        program_scroll.input.enableDrag();
        program_scroll.input.allowVerticalDrag = false;
        program_scroll.events.onDragStart.add(programScrollOnDragStart, this);
        program_scroll.events.onDragStop.add(programScrollOnDragStop, this);
        program_scroll.addChild(tmp_scroll);
    }

    function createCommandPanel(){
         //Commands
        command = game.add.group();
        command.fixedToCamera = true;
        command.inputEnableChildren = true;
        command.x = (width - 9.5 * div.width)/2;
        command.y = height - div.height * 1.5;
        command.w = 9.5 * div.width;
        command.h = div.height * 1.5;
        command.cameraOffset = command.position;
        var command_holder = game.add.graphics(0, 0);
        command_holder.beginFill(0xc1c1c1, 0.85);
        command_holder.drawRect(0, 0, command.w, command.h);
        command_holder.endFill();
        command.addChild(command_holder);


        var command_names = ['forward', 'backward', 'left', 'right', 'lo', 'op'];
        var x = div.width/2;
        for (var i in command_names){
            commands[command_names[i]] = command.create(x, div.height/4, command_names[i]);
            x += 3 * div.width/2;
        }
        {% for key, value in count.items %}
            commands.{{ key }}.count = {'value': {{ value }} };
        {% endfor %}

        for (var key in commands){
            var object = commands[key];
            //Draggable
            object.inputEnabled = true;
            object.input.enableDrag();
            object.events.onDragStart.add(commandOnDragStart, this);
            object.events.onDragStop.add(commandOnDragStop, this);
            // Counters
            var text = object.count.value
            object.count.text = game.add.text(object.x + div.width/2, object.y + div.height + 5, text, defaultFont, command);
            object.count.text.anchor.setTo(0.5, 0.5);

        }
        // End Commands
    }

    function createScenePanel(){
        scene = game.add.group();
        scene.x = program.x;
        scene.y = program.y + program.height;
        scene.w = width;
        scene.h = height - program.height - command.height;
        // Remove it ->
        var x, y, current;
        {% for i in tiles %}
            x = {{ i.x }}*div.width;
            y = {{ i.y }}*div.height;
            current = scene.create(x, y, "{{ i.type }}");
            tiles.push(current);

        {% endfor %}

        x = {{ hero.x }}*div.width + div.width/2;
        y = {{ hero.y }}*div.height + div.height/2;
        hero = scene.create(x, y, "{{ hero.type }}");
        hero.anchor.setTo(0.5, 0.5);
        hero.direction  = {{ hero.direction }};
        hero.angle = {{ hero.direction }} * 90;
        hero.inputEnabled = true;
        hero.events.onInputDown.add(heroOnInputDown, this);
        hero.originalPosition = hero.position.clone();
        hero.originalDirection = hero.direction;
    }

    var tween;
    function update() {
        if (sceneCheck().length < 1){
            game.camera.shake(0.01,  500);
            gameSuccess(false);
        }
    }

    function gameCheckSucceed() {
            var tiles = sceneCheck();
            var success = false;
            for (var i in tiles){
                if (tiles[i].key == "tile_finish"){
                    success = true;
                }
            }
            gameSuccess(success);
        }

    function gameStart(){
        hero.input.enabled = false;
        tween = createTween(programCompile());
        tween[0].start();
        tween[tween.length-1].onComplete.add(gameCheckSucceed, this);
    }

    function gameSuccess(success) {
        if (success){
            alert("w0w");
        }else{
            game.tweens.removeAll();
            heroReset();
        }
    }

    function deltaCommandCount(key, delta){
        commands[key].count.value += delta;
        commands[key].count.text.setText(commands[key].count.value);
    }

    function programAddCommand(command, pointer){
        var index = programs.length;
        if (pointer.y < program.y + program.h){
            index = Math.floor(pointer.x/div.width);
            if (index > programs.length){
                index = programs.length;
            }
        }
        var current = program.create(0, div.height/4, command.key);
        current.inputEnabled = true;
        current.input.enableDrag();
        current.events.onDragStart.add(programOnDragStart, this);
        current.events.onDragStop.add(programOnDragStop, this);
        current.input.allowVerticalDrag = false;

        programs.splice(index, 0, current);

        programAlignCommands();
    }

    function programAlignCommands(){
        // TODO Maybe animation
        if (programs.length == 0){
            return;
        }
        if (programs[0].x > 0){
            programs[0].x = 0;
        }
        for (var i = 1; i < programs.length; ++i){
            programs[i].alignTo(programs[i-1], Phaser.RIGHT_CENTER);
        }
    }

    function programCompile(){
        var pure = [];
        for (var i in programs){
            var current =  programs[i].key;
            pure.push(current);
        }
        //TODO Handel LO and OP later on
        return pure;
    }

    function createTween(commands){
        var result = [];
        var len = div.height;
        var direction = hero.direction;
        var x = hero.x;
        var y = hero.y;

        for (var i in commands){
            var tmp;

            if (commands[i] == 'forward') {
                switch (direction){
                case 0:
                    y -= len;
                    break;
                case 1:
                    x += len;
                    break;
                case 2:
                    y += len;
                    break;
                case 3:
                    x -= len;
                    break;
                }
                tmp = game.add.tween(hero).to({x: x, y: y}, speed, "Quart.easeOut");
            }else if(commands[i] == 'backward'){
                switch (direction){
                case 0:
                    y += len;
                    break;
                case 1:
                    x -= len;
                    break;
                case 2:
                    y -= len;
                    break;
                case 3:
                    x += len;
                    break;
                }
                tmp = game.add.tween(hero).to({x: x, y: y}, speed, "Quart.easeOut");
            }else if(commands[i] == 'left'){
                tmp = game.add.tween(hero).to({angle: (direction-1)*90}, speed, "Quart.easeOut");
                direction -= 1;
            }else if(commands[i] == 'right'){
                tmp = game.add.tween(hero).to({angle: (direction+1)*90}, speed, "Quart.easeOut");
                direction += 1;
            }

            result.push(tmp);
            if (result.length > 1){
                result[result.length - 2].chain(tmp);
            }
        }
        return result;
    }

    function sceneCheck(){
        var result = [];
        for (var i in tiles){
            var x = tiles[i].x;
            var y = tiles[i].y;
            var h = tiles[i].height;
            var w = tiles[i].width;
            if (hero.x >= x && hero.x <= x + w && hero.y >= y && hero.y <= y + h){
                result.push(tiles[i]);
            }
        }
        return result;
    }

    function heroReset() {
        // TODO Sometimes it's doesnt resets
        hero.position = hero.originalPosition.clone();
        hero.direction = hero.originalDirection;
        hero.angle = hero.direction * 90;
        hero.input.enabled = true;
    }
    ///////////////////////////////////////////////////////
    //Events
    //////////////////////////////////////////////////////
    function commandOnDragStart(sprite, pointer) {
        sprite.originalPosition = sprite.position.clone();
    }

    function commandOnDragStop(sprite, pointer) {
        if (sprite.count.value > 0){
            programAddCommand(sprite, pointer);
            deltaCommandCount(sprite.key, -1);
        }
        sprite.position = sprite.originalPosition;
    }

    function programOnDragStart(sprite, pointer) {
        sprite.originalPosition = sprite.position.clone();
    }

    function programOnDragStop(sprite, pointer) {
        var index = programs.indexOf(sprite);
        programs.splice(index, 1);
        if (Math.abs(sprite.x - sprite.originalPosition.x) > sprite.width/2){
            programAddCommand(sprite, pointer);
        }else{
           deltaCommandCount(sprite.key, 1);
        }
        sprite.destroy();
        programAlignCommands();
    }
    
    function programScrollOnDragStart(sprite, pointer) {
        sprite.originalPosition = sprite.position.clone();
    }

    function programScrollOnDragStop(sprite, pointer) {
        // TODO Resize scroll only if enough content in program
        if (sprite.position.x < 0){
            sprite.position.x = 0;
        }else if (sprite.position.x + sprite.width > width){
            sprite.position.x = width - sprite.width;
        }

        var deltaX = sprite.originalPosition.x - sprite.position.x;
        if (programs.length > 0) {
            // TODO This
            // var animation = game.add.tween(programs[0]).to({x: programs[0] + deltaX}, speed, "Quart.easeOut");
            // animation.start();
            programs[0].x += deltaX;
            programAlignCommands();
        }

    }

    function heroOnInputDown(sprite, pointer) {
        gameStart();
    }

</script>

</body>
</html>